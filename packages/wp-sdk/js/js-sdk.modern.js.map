{"version":3,"file":"js-sdk.modern.js","sources":["../src/donationWidget.ts","../src/version.ts"],"sourcesContent":["import {\n  disableBodyScroll,\n  enableBodyScroll,\n  clearAllBodyScrollLocks,\n} from \"body-scroll-lock\"\n\nimport elementClosest from \"element-closest\"\nimport \"core-js/features/array/includes\"\nimport \"core-js/features/array/fill\"\nimport { ModalProps } from \"./types\"\nimport \"core-js/features/promise\"\nimport { version } from \"./version\"\nimport \"core-js/features\"\nimport \"element-remove\"\n\nimport { css,keyframes } from \"goober\";\n\nexport interface CustomWindow extends Window {\n  Everfund: EverfundClient\n}\n\ndeclare let window: CustomWindow\n\nclass EverfundClient {\n  private donationWidgetOpen: boolean = false\n  private onSuccess: ModalProps[\"onSuccess\"] = () => {}\n  private onFailure: ModalProps[\"onFailure\"] = () => {}\n  private onClose: ModalProps[\"onClose\"] = () => {}\n  version: string\n\n  constructor() {\n    this.version = version\n    this.setupButtonListeners()\n    this.setupIframeListeners()\n    elementClosest(window)\n  }\n\n  public modal({\n    code,\n    domain,\n    closeOnSuccess,\n    onSuccess,\n    onFailure,\n    onClose,\n  }: ModalProps) {\n    console.warn(\"everfund.modal is deprecated in the next update, please use everfund.donationWidget instead\")\n    this.donationWidget({\n      code,\n      domain,\n      closeOnSuccess,\n      onSuccess,\n      onFailure,\n      onClose,\n    })\n  }\n\n  public donationWidget({\n    code,\n    domain,\n    closeOnSuccess,\n    onSuccess,\n    onFailure,\n    onClose,\n  }: ModalProps) {\n    if (onSuccess) this.onSuccess = onSuccess\n    if (onFailure) this.onFailure = onFailure\n    if (onClose) this.onClose = onClose\n    const origin = window.location.origin\n\n    let makeQS = function (obj: any) {\n      var str = []\n      for (var p in obj)\n        if (obj[p] && obj.hasOwnProperty(p)) {\n          str.push(encodeURIComponent(p) + \"=\" + encodeURIComponent(obj[p]))\n        }\n      return str.join(\"&\")\n    }\n\n    try {\n      const modalFrame = document.createElement(\"iframe\")\n      modalFrame.src = `https://${domain || \"evr.fund\"}/${code}/modal?${makeQS({\n        embed_origin: origin,\n        embeded: true,\n        close_on_success: closeOnSuccess,\n      })}`\n\n      // @ts-ignore\n      modalFrame.allowPaymentRequest = true\n\n      const cssEmbedIframe = css({\n        border: \"none\",\n        width: \"100%\",\n        margin: 0,\n        height: \"100%\",\n      })\n      modalFrame.id = \"ef-modal\"\n      modalFrame.className = cssEmbedIframe\n\n      modalFrame.addEventListener(\"load\", function () {\n        const loadingSpinner =\n          document.querySelector<HTMLDivElement>(\".ldsRing\")\n        const modalWrap = document.querySelector<HTMLDivElement>(\".embedModal\")\n        loadingSpinner?.remove()\n        modalWrap!.style.transform = \"opacity(1)\"\n      })\n\n      const modalWrap = document.createElement(\"div\")\n\n      const cssEmbedModal = css({\n        pointerEvents: \"all\",\n        zIndex: \"9999999\",\n        display: \"flex\",\n        width: \"100%\",\n        transform: \"opacity(0)\",\n        transition: \"transform 0.3s ease\",\n        overflowY: \"auto\",\n        \"-webkit-overflow-scrolling\": \"touch\",\n        height: \"100%\",\n      })\n\n      modalWrap.className = `embedModal ${cssEmbedModal}`\n      modalWrap.appendChild(modalFrame)\n\n      const embedContainer = document.createElement(\"div\")\n      disableBodyScroll(embedContainer)\n\n      const loadingSpinner = document.createElement(\"div\")\n\n      const cssKeyframeLDsring = keyframes({\n        \"0%\": { transform: \"rotate(0deg)\" },\n        \"100%\": { transform: \"rotate(360deg)\" },\n      })\n\n      const cssLdsRing = css({\n        display: \"inline-block\",\n        position: \"absolute\",\n        left: \"calc(50% - 32px)\",\n        top: \"calc(50% - 32px)\",\n        width: \"64px\",\n        height: \"64px\",\n        \"& div\": {\n          boxSizing: \"border-box\",\n          display: \"block\",\n          position: \"absolute\",\n          width: \"51px\",\n          height: \"51px\",\n          margin: \"6px\",\n          border: \"6px solid white\",\n          borderRadius: \"50%\",\n          animation: `${cssKeyframeLDsring} 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite`,\n          borderColor: \"white transparent transparent transparent\",\n        },\n        \"& div:nth-child(1)\": {\n          animationDelay: \" -0.45s\",\n        },\n        \"& div:nth-child(2)\": {\n          animationDelay: \" -0.3s\",\n        },\n        \"& div:nth-child(3)\": {\n          animationDelay: \" -0.15s\",\n        },\n      })\n      loadingSpinner.className = `ldsRing ${cssLdsRing}`\n\n      const div = document.createElement(\"div\")\n\n      Array(4)\n        .fill(4)\n        .forEach(function () {\n          loadingSpinner.appendChild(div)\n        })\n\n      const cssEmbedContainer = css({\n        position: \"fixed\",\n        top: \"0\",\n        left: \"0\",\n        right: \"0\",\n        bottom: \"0\",\n        background: \"rgba(0, 0, 0, 0.7)\",\n        zIndex: \"9999998\",\n        display: \"flex\",\n        justifyContent: \"space-around\",\n        alignItems: \"stretch\",\n        backdropFilter: \"blur(8px)\",\n      })\n\n      embedContainer.className = `embedContainer ${cssEmbedContainer}`\n      embedContainer.appendChild(loadingSpinner)\n      embedContainer.appendChild(modalWrap)\n      // disableBodyScroll(embedContainer)\n      document.body.appendChild(embedContainer)\n    } catch (e) {\n      console.log(e)\n\n      window.location.replace(\n        `https://${domain || \"evr.fund\"}/${code}/modal?${makeQS({\n          return_url: origin,\n        })}`\n      )\n    }\n  }\n\n  private setupButtonListeners() {\n    document.addEventListener(\n      \"click\",\n      function (e: MouseEvent) {\n        const match = (e.target as HTMLElement).closest(\"[data-ef-modal]\")\n\n        if (!match || Everfund.donationWidgetOpen) return\n        e.preventDefault()\n        e.stopPropagation()\n\n        let code = match.getAttribute(\"data-ef-modal\")\n\n        if (!code) {\n          console.error(\n            'Everfund: data-ef-modal is required! eg <button data-ef-modal=\"rjww\"> modal </button>'\n          )\n          return\n        }\n\n        if (\n          !!new RegExp(\n            \"^(https?:\\\\/\\\\/)?\" + // protocol\n              \"((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|\" + // domain name\n              \"((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))\" + // OR ip (v4) address\n              \"(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*\" + // port and path\n              \"(\\\\?[;&a-z\\\\d%_.~+=-]*)?\" + // query string\n              \"(\\\\#[-a-z\\\\d_]*)?$\",\n            \"i\"\n          ).test(code)\n        ) {\n          console.warn(\n            `Everfund: url's are deprecated please use a code instead`\n          )\n\n          code = new URL(code).pathname.replace(\"/\", \"\")\n        }\n\n        Everfund.donationWidgetOpen = true\n        Everfund.donationWidget({\n          code,\n          onSuccess: () => {},\n          onFailure: () => {},\n          onClose: () => {\n            clearAllBodyScrollLocks()\n          },\n        })\n      },\n      false\n    )\n  }\n\n  private setupIframeListeners() {\n    window.addEventListener(\n      \"message\",\n      function (e) {\n        const embed = document.querySelector(\".\" + \"embedContainer\")\n        switch (e.data.message) {\n          case \"everfund:ready\":\n            const loadingSpinner =\n              document.querySelector<HTMLDivElement>(\"#ldsRing\")\n            const modalWrap = document.querySelector<HTMLDivElement>(\n              \".\" + \"embedModal\"\n            )\n            loadingSpinner?.remove()\n            modalWrap!.style.transform = \"opacity(1)\"\n            break\n          case \"everfund:success\":\n            const data = e.data.content\n            Everfund.onSuccess(data)\n            break\n          case \"everfund:failure\":\n            Everfund.onFailure(e.data.content)\n            break\n          case \"everfund:close\":\n            embed && enableBodyScroll(embed)\n            embed && embed.remove()\n            Everfund.donationWidgetOpen = false\n            Everfund.onClose()\n            // clearAllBodyScrollLocks();\n            break\n        }\n      },\n      false\n    )\n  }\n}\n\nconst Everfund = new EverfundClient()\n\nexport default Everfund\n","// Generated by genversion.\nexport const version = '1.3.3';\n"],"names":["Everfund","constructor","donationWidgetOpen","onSuccess","onFailure","this","onClose","version","setupButtonListeners","setupIframeListeners","elementClosest","window","modal","code","domain","closeOnSuccess","console","warn","donationWidget","origin","location","makeQS","obj","str","p","hasOwnProperty","push","encodeURIComponent","join","modalFrame","document","createElement","src","embed_origin","embeded","close_on_success","allowPaymentRequest","cssEmbedIframe","css","border","width","margin","height","id","className","addEventListener","loadingSpinner","querySelector","modalWrap","remove","style","transform","cssEmbedModal","pointerEvents","zIndex","display","transition","overflowY","appendChild","embedContainer","disableBodyScroll","cssKeyframeLDsring","keyframes","cssLdsRing","position","left","top","boxSizing","borderRadius","animation","borderColor","animationDelay","div","Array","fill","forEach","cssEmbedContainer","right","bottom","background","justifyContent","alignItems","backdropFilter","body","e","log","replace","return_url","match","target","closest","preventDefault","stopPropagation","getAttribute","RegExp","test","URL","pathname","clearAllBodyScrollLocks","error","embed","data","message","content","enableBodyScroll"],"mappings":"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"}